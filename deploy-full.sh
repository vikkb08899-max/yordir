#!/bin/bash

# –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-full.sh

set -e

echo "üöÄ –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –ø—Ä–æ–µ–∫—Ç–∞..."

# –î–µ–ø–ª–æ–∏–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
echo "üì¶ –î–µ–ø–ª–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
./deploy-frontend.sh

# –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∫–µ–Ω–¥–∞
echo "üì° –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä..."
SERVER_IP="91.219.237.178"
SERVER_USER="root"

ssh -o PubkeyAuthentication=no $SERVER_USER@$SERVER_IP << 'EOF'
    echo "üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∫–µ–Ω–¥–∞..."
    cd /home/projtron01
    
    # –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git
    git fetch origin
    git reset --hard origin/main
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    cd backend
    npm install
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–µ–∫–µ–Ω–¥
    if pm2 list | grep -q "exchange-backend"; then
        pm2 restart exchange-backend
        echo "‚úÖ –ë–µ–∫–µ–Ω–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
    else
        pm2 start server.js --name "exchange-backend"
        echo "‚úÖ –ë–µ–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω"
    fi
EOF

echo "‚úÖ –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!" 